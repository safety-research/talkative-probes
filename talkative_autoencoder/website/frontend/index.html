<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consistency Lens - Talkative Autoencoder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9F5F0;
            color: #5D4037;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #EFEBE9; }
        ::-webkit-scrollbar-thumb { background: #D7CCC8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #BCAAA4; }
        
        .token-box-container {
            display: inline-block;
            position: relative;
            vertical-align: bottom;
            border: 1px solid #D7CCC8;
            background-color: white;
            padding: 2px 6px;
            margin: 2px;
            border-radius: 4px;
        }

        .token-box {
            line-height: 1.5;
        }
        
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background-color: #3E2723;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            white-space: pre-wrap;
            word-break: break-word;
            width: max-content; 
            max-width: 300px;
            z-index: 20;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .token-box-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        .rotated-token-wrapper {
            position: relative;
            height: 120px;
            width: 100%;
        }

        .rotated-token {
            position: absolute;
            bottom: 10px;
            left: 0;
            transform: rotate(-15deg) translate(3px,0);
            transform-origin: bottom left;
            white-space: nowrap;
            font-size: 0.8rem;
            z-index: 10;
        }
        
        .explanation-word {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .primary-btn {
            background-color: #E65100; color: white;
            font-weight: 600; border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .primary-btn:hover { background-color: #BF360C; }
        
        .secondary-btn {
            background-color: white; border: 1px solid #D7CCC8; color: #5D4037;
            font-weight: 600; border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .secondary-btn:hover { border-color: #BCAAA4; background-color: #F5F5F5; }
        .secondary-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .parameter-section {
            background: #EFEBE9;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .loading {
            display: none;
        }
        .loading.active {
            display: block;
        }

        .error-message {
            background-color: #fee;
            border: 1px solid #fcc;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        #advancedSettings {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }
        #advancedSettings.collapsed {
            max-height: 0;
        }
        #advancedSettings.expanded {
            max-height: 2000px;
        }

        .resize-handle {
            position: absolute;
            top: 0;
            right: -4px;
            width: 8px;
            height: 100%;
            cursor: col-resize;
            z-index: 10;
        }
        
        #output-table th {
            position: relative;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <h1 class="text-3xl font-bold mb-8 text-center text-[#5D4037]">Consistency Lens - Talkative Autoencoder</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Input & Parameters Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Input Text</h2>
                    <textarea id="inputText" 
                        class="w-full h-32 p-3 border rounded-md resize-none bg-transparent text-[#5D4037] border-slate-200 focus:ring-2 focus:ring-orange-500"
                        placeholder="Enter text to analyze...">The capital of France is Paris.</textarea>
                    
                    <!-- Basic Settings -->
                    <div class="parameter-section mt-4">
                        <h3 class="font-semibold mb-3">Optimization Settings</h3>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium mb-1">Number of Rollouts (k)</label>
                            <input type="range" id="kRollouts" min="1" max="64" value="8" class="w-full">
                            <div class="flex justify-between text-xs text-gray-600">
                                <span>1</span>
                                <span id="kRolloutsValue" class="font-medium">8</span>
                                <span>64</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">More rollouts = better explanations but slower</p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium mb-1">Batch Size</label>
                            <div class="flex items-center">
                                <input type="checkbox" id="autoBatchSize" checked class="mr-2">
                                <label for="autoBatchSize" class="text-sm">Auto-calculate (256 รท k)</label>
                            </div>
                            <input type="number" id="batchSize" min="1" max="256" value="32" 
                                class="w-full mt-2 p-2 border rounded" disabled>
                            <p id="batchSizeInfo" class="text-xs text-gray-500 mt-1">Auto-calculated: 32</p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium mb-1">Temperature</label>
                            <input type="range" id="temperature" min="0.1" max="2.0" step="0.1" value="1.0" class="w-full">
                            <div class="flex justify-between text-xs text-gray-600">
                                <span>0.1</span>
                                <span id="temperatureValue" class="font-medium">1.0</span>
                                <span>2.0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Settings Toggle -->
                    <button id="advancedToggle" class="text-blue-600 text-sm mb-3">
                        โถ Show Advanced Settings
                    </button>
                    
                    <!-- Advanced Settings -->
                    <div id="advancedSettings" class="collapsed">
                        <div class="parameter-section">
                            <h3 class="font-semibold mb-3">Analysis Options</h3>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="calculateSalience" checked class="mr-2">
                                    <span class="text-sm">Calculate Salience</span>
                                </label>
                                
                                <label class="flex items-center">
                                    <input type="checkbox" id="tunedLens" checked class="mr-2">
                                    <span class="text-sm">Tuned Lens</span>
                                </label>
                                
                                <label class="flex items-center">
                                    <input type="checkbox" id="logitLens" class="mr-2">
                                    <span class="text-sm">Logit Lens</span>
                                </label>
                                
                                <label class="flex items-center">
                                    <input type="checkbox" id="noEval" class="mr-2">
                                    <span class="text-sm">Skip Evaluation</span>
                                </label>
                                
                                <label class="flex items-center">
                                    <input type="checkbox" id="noKL" class="mr-2">
                                    <span class="text-sm">Skip KL Divergence</span>
                                </label>
                                
                                <label class="flex items-center">
                                    <input type="checkbox" id="doHardTokens" class="mr-2">
                                    <span class="text-sm">Hard Tokens</span>
                                </label>
                            </div>
                            
                            <div class="mt-3">
                                <label class="block text-sm font-medium mb-1">Random Seed</label>
                                <input type="number" id="seed" value="42" class="w-full p-2 border rounded">
                            </div>
                        </div>
                        
                        <div class="parameter-section">
                            <h3 class="font-semibold mb-3">Rollout Settings</h3>
                            
                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1">Rollout Batch Size</label>
                                <input type="number" id="rolloutBatchSize" min="1" max="32" value="8" 
                                    class="w-full p-2 border rounded">
                                <p class="text-xs text-gray-500 mt-1">How many positions to process at once</p>
                            </div>
                            
                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1">Samples per Iteration</label>
                                <input type="number" id="numSamples" min="1" max="64" value="16" 
                                    class="w-full p-2 border rounded">
                            </div>
                        </div>
                    </div>
                    
                    <button id="analyzeBtn" 
                        class="w-full primary-btn py-2 px-4 shadow-sm transform hover:scale-105 mt-4">
                        Analyze Text
                    </button>
                    
                    <div id="loading" class="loading text-center mt-4">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"></div>
                        <p class="mt-2 text-gray-600">Processing...</p>
                        <p id="queuePosition" class="text-sm text-gray-500"></p>
                    </div>
                    
                    <div id="error" class="error-message" style="display: none;"></div>
                </div>
                
                <!-- Connection Status -->
                <div class="mt-4 text-center">
                    <span id="connectionStatus" class="text-sm text-gray-600">Disconnected</span>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Analysis Results</h2>
                    
                    <!-- Metadata Display -->
                    <div id="metadata-display" class="mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg hidden text-sm text-[#5D4037]"></div>
                    
                    <!-- Full Text Display -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2 text-[#5D4037]">Full Text</h3>
                        <div id="full-text-container" class="p-4 bg-white rounded-lg border border-slate-200 shadow-sm leading-relaxed">
                            <p id="full-text-placeholder" class="text-slate-500">Full text will appear here after analyzing.</p>
                        </div>
                    </div>
                    
                    <!-- Display Controls -->
                    <div id="display-controls" class="mb-4 flex-wrap items-center gap-x-8 gap-y-4 hidden">
                        <div id="column-toggle-container" class="flex items-center gap-4"></div>
                        <button id="transpose-btn" class="flex items-center justify-center gap-2 px-5 py-2 secondary-btn shadow-sm transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                            Transpose
                        </button>
                        <div id="line-spacing-control" class="flex items-center gap-4">
                            <label for="line-spacing-slider" class="font-semibold text-[#5D4037]">Line Spacing:</label>
                            <input id="line-spacing-slider" type="range" min="0" max="10" value="0" class="w-48">
                        </div>
                        <div id="col-width-control" class="flex items-center gap-4 hidden">
                            <label for="col-width-slider" class="font-semibold text-[#5D4037]">Column Width:</label>
                            <input id="col-width-slider" type="range" min="80" max="400" value="80" class="w-48">
                        </div>
                        <div id="salience-control" class="flex items-center gap-2">
                            <input type="checkbox" id="salience-toggle" class="h-4 w-4 rounded border-slate-300 text-orange-600 focus:ring-orange-500">
                            <label for="salience-toggle" class="font-semibold text-[#5D4037]">Color by Salience</label>
                        </div>
                        <div id="salience-colorbar" class="h-2 w-56 rounded hidden" title="Salience scale"></div>
                    </div>
                    
                    <!-- Visualization -->
                    <div id="output-container">
                        <div id="output-inner-wrapper" class="overflow-x-auto w-full">
                            <p id="output-placeholder" class="text-slate-500 text-center mt-16">Your analysis results will appear here.</p>
                            <table id="output-table" class="min-w-full hidden">
                                <thead id="table-head"></thead>
                                <tbody id="table-body"></tbody>
                            </table>
                            <div id="transposed-view" class="hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="app.js"></script>
</body>
</html>