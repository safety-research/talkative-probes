<?xml version="1.0" encoding="UTF-8"?>
<svg width="1250" height="720" xmlns="http://www.w3.org/2000/svg">
  <!-- Definitions for gradients and filters -->
  <defs>
    <!-- Gradients -->
    <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#f8fafc;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#f1f5f9;stop-opacity:1" />
    </linearGradient>
    
    <linearGradient id="blueGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
    </linearGradient>
    
    <linearGradient id="redGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
    </linearGradient>
    
    <linearGradient id="purpleGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#a855f7;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#9333ea;stop-opacity:1" />
    </linearGradient>
    
    <linearGradient id="greenGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
    
    <linearGradient id="orangeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#fb923c;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#f97316;stop-opacity:1" />
    </linearGradient>
    
    <!-- Shadows and effects -->
    <filter id="softShadow" x="-50%" y="-50%" width="200%" height="200%">
      <feDropShadow dx="0" dy="4" stdDeviation="8" flood-opacity="0.15"/>
    </filter>
    
    <filter id="tokenShadow" x="-50%" y="-50%" width="200%" height="200%">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.1"/>
    </filter>
    
    <filter id="glow">
      <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
    
    <!-- Arrow markers -->
    <marker id="arrowhead" markerWidth="12" markerHeight="12" refX="11" refY="4" orient="auto">
      <polygon points="0 0, 12 4, 0 8" fill="#64748b"/>
    </marker>
    
    <marker id="arrowhead-blue" markerWidth="12" markerHeight="12" refX="11" refY="4" orient="auto">
      <polygon points="0 0, 12 4, 0 8" fill="#3b82f6"/>
    </marker>
    
    <marker id="arrowhead-orange" markerWidth="12" markerHeight="12" refX="11" refY="4" orient="auto">
      <polygon points="0 0, 12 4, 0 8" fill="#f97316"/>
    </marker>
    
    <marker id="arrowhead-red" markerWidth="12" markerHeight="12" refX="11" refY="4" orient="auto">
      <polygon points="0 0, 12 4, 0 8" fill="#dc2626"/>
    </marker>
  </defs>
  
  <!-- Background -->
  <rect width="1250" height="720" fill="url(#bgGradient)"/>
  
  <!-- Title -->
  <text x="625" y="35" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="30" font-weight="700" fill="#0f172a">
    Talkative Probes
  </text>
  <text x="625" y="58" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="15" fill="#64748b">
    Neural activations ↔ Natural language interface
  </text>
  
  <!-- Legend Box (moved to top right) -->
  <g id="legend" transform="translate(1020, 80)">
    <rect x="0" y="0" width="200" height="150" rx="12" fill="white" stroke="#e2e8f0" stroke-width="1.5" filter="url(#softShadow)"/>
    <text x="100" y="20" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="13" font-weight="600" fill="#1e293b">Legend</text>
    
    <!-- Trainable prefix (decoder) -->
    <g transform="translate(15, 35)">
      <rect x="0" y="0" width="20" height="20" rx="3" fill="#9333ea" fill-opacity="0.2" stroke="#9333ea" stroke-width="2" stroke-dasharray="3,2"/>
      <text x="28" y="14" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#475569">Decoder Prefix</text>
    </g>
    
    <!-- Trainable prefix/postfix (encoder) -->
    <g transform="translate(15, 60)">
      <rect x="0" y="0" width="20" height="20" rx="3" fill="#059669" fill-opacity="0.2" stroke="#059669" stroke-width="2" stroke-dasharray="3,2"/>
      <text x="28" y="14" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#475569">Encoder Pre/Postfix</text>
    </g>
    
    <!-- Linear Layer -->
    <rect x="15" y="88" width="20" height="8" rx="2" fill="#6366f1"/>
    <text x="43" y="94" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#475569">Linear Layer</text>
    
    <!-- Frozen -->
    <rect x="15" y="108" width="20" height="20" rx="4" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
    <text x="43" y="120" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#475569">Frozen Component</text>
  </g>
  
  <!-- Top section: Output distributions and KL divergence -->
  <g id="output-section" transform="translate(0, 85)">
    <!-- Left output: Forward with A -->
    <g transform="translate(100, 0)">
      <rect x="0" y="25" width="180" height="65" rx="12" fill="url(#blueGradient)" filter="url(#softShadow)"/>
      <text x="90" y="50" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="14" font-weight="600" fill="white">Forward with A</text>
      <text x="90" y="70" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="11" fill="#dbeafe">P(tok_{p+1} | context, A)</text>
      
      <!-- Token probabilities -->
      <g transform="translate(15, -15)">
        <rect x="0" y="0" width="38" height="30" rx="6" fill="#22c55e" filter="url(#tokenShadow)"/>
        <text x="19" y="20" text-anchor="middle" font-family="monospace" font-size="10" fill="white">cat</text>
        
        <rect x="46" y="0" width="38" height="30" rx="6" fill="#22c55e" opacity="0.7" filter="url(#tokenShadow)"/>
        <text x="65" y="20" text-anchor="middle" font-family="monospace" font-size="10" fill="white">dog</text>
        
        <rect x="92" y="0" width="38" height="30" rx="6" fill="#22c55e" opacity="0.5" filter="url(#tokenShadow)"/>
        <text x="111" y="20" text-anchor="middle" font-family="monospace" font-size="10" fill="white">bird</text>
        
        <text x="142" y="20" font-family="system-ui, -apple-system, sans-serif" font-size="13" fill="#94a3b8">...</text>
      </g>
    </g>
    
    <!-- Right output: Forward with A' -->
    <g transform="translate(740, 0)">
      <rect x="0" y="25" width="180" height="65" rx="12" fill="url(#orangeGradient)" filter="url(#softShadow)"/>
      <text x="90" y="50" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="14" font-weight="600" fill="white">Forward with A'</text>
      <text x="90" y="70" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="11" fill="#fed7aa">P(tok_{p+1} | context, A')</text>
      
      <!-- Token probabilities -->
      <g transform="translate(15, -15)">
        <rect x="0" y="0" width="38" height="30" rx="6" fill="#f97316" filter="url(#tokenShadow)"/>
        <text x="19" y="20" text-anchor="middle" font-family="monospace" font-size="10" fill="white">cat</text>
        
        <rect x="46" y="0" width="38" height="30" rx="6" fill="#f97316" opacity="0.7" filter="url(#tokenShadow)"/>
        <text x="65" y="20" text-anchor="middle" font-family="monospace" font-size="10" fill="white">rat</text>
        
        <rect x="92" y="0" width="38" height="30" rx="6" fill="#f97316" opacity="0.5" filter="url(#tokenShadow)"/>
        <text x="111" y="20" text-anchor="middle" font-family="monospace" font-size="10" fill="white">dog</text>
        
        <text x="142" y="20" font-family="system-ui, -apple-system, sans-serif" font-size="13" fill="#94a3b8">...</text>
      </g>
    </g>
    
    <!-- KL Divergence in center -->
    <g transform="translate(520, 35)">
      <circle cx="0" cy="20" r="38" fill="url(#redGradient)" filter="url(#softShadow)"/>
      <text x="0" y="26" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="24" font-weight="700" fill="white">KL</text>
      <text x="0" y="70" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="13" font-weight="500" fill="#dc2626">Divergence</text>
      
      <!-- Arrows pointing to KL -->
      <path d="M -330 20 Q -200 -10 -38 20" stroke="#3b82f6" stroke-width="2.5" fill="none" marker-end="url(#arrowhead-blue)"/>
      <path d="M 310 20 Q 200 -10 38 20" stroke="#f97316" stroke-width="2.5" fill="none" marker-end="url(#arrowhead-orange)"/>
    </g>
  </g>
  
  <!-- Main content area -->
  <g transform="translate(0, 230)">
    <!-- Left: LLM Forward Pass -->
    <g id="llm-section" transform="translate(70, 0)">
      <!-- Forward pass container -->
      <rect x="0" y="0" width="200" height="360" rx="16" fill="white" stroke="#e2e8f0" stroke-width="2" filter="url(#softShadow)"/>
      <text x="100" y="25" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="15" font-weight="600" fill="#1e293b">LLM Forward Pass</text>
      
      <!-- Layer stack -->
      <g transform="translate(30, 45)">
        <!-- Bottom layers (frozen) -->
        <rect x="0" y="265" width="140" height="35" rx="8" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
        <text x="70" y="287" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="12" fill="#475569">Layers 1-5</text>
        
        <rect x="0" y="220" width="140" height="35" rx="8" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
        <text x="70" y="242" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="12" fill="#475569">Layers 6-10</text>
        
        <!-- Target layer -->
        <g>
          <rect x="-10" y="155" width="160" height="50" rx="10" fill="url(#redGradient)" stroke="#dc2626" stroke-width="2" filter="url(#softShadow)"/>
          <text x="70" y="177" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="14" font-weight="600" fill="white">Layer L</text>
          <text x="70" y="193" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="11" fill="#fecaca">Extract A here</text>
        </g>
        
        <!-- Top layers (frozen) -->
        <rect x="0" y="100" width="140" height="35" rx="8" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
        <text x="70" y="122" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="12" fill="#475569">Layers L+1...</text>
        
        <rect x="0" y="55" width="140" height="35" rx="8" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
        <text x="70" y="77" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="12" fill="#475569">Layers N-1</text>
        
        <rect x="0" y="10" width="140" height="35" rx="8" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
        <text x="70" y="32" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="12" fill="#475569">Layer N</text>
      </g>
      
      <!-- Vertical flow arrow -->
      <path d="M 100 320 L 100 75" stroke="#64748b" stroke-width="3" fill="none" marker-end="url(#arrowhead)" opacity="0.4"/>
    </g>
    
    <!-- Input tokens below LLM -->
    <g transform="translate(50, 375)">
      <text x="120" y="-8" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="13" font-weight="500" fill="#64748b">Input Context</text>
      <g transform="translate(10, 0)">
        <rect x="0" y="0" width="40" height="33" rx="8" fill="#94a3b8" filter="url(#tokenShadow)"/>
        <text x="20" y="22" text-anchor="middle" font-family="monospace" font-size="10" fill="white">tok₁</text>
        
        <rect x="48" y="0" width="40" height="33" rx="8" fill="#94a3b8" filter="url(#tokenShadow)"/>
        <text x="68" y="22" text-anchor="middle" font-family="monospace" font-size="10" fill="white">tok₂</text>
        
        <rect x="96" y="0" width="40" height="33" rx="8" fill="#94a3b8" filter="url(#tokenShadow)"/>
        <text x="116" y="22" text-anchor="middle" font-family="monospace" font-size="10" fill="white">tok₃</text>
        
        <text x="144" y="22" font-family="system-ui, -apple-system, sans-serif" font-size="13" fill="#94a3b8">...</text>
        
        <rect x="162" y="0" width="40" height="33" rx="8" fill="url(#redGradient)" filter="url(#softShadow)"/>
        <text x="182" y="22" text-anchor="middle" font-family="monospace" font-size="10" font-weight="600" fill="white">tokₚ</text>
      </g>
    </g>
    
    <!-- Activation A -->
    <g transform="translate(340, 180)">
      <circle cx="0" cy="0" r="38" fill="url(#redGradient)" filter="url(#glow)"/>
      <text x="0" y="7" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="22" font-weight="700" fill="white">A</text>
      <text x="0" y="-52" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="12" font-weight="500" fill="#64748b">Activation at position P</text>
      
      <!-- Arrow from layer -->
      <path d="M -70 0 L -38 0" stroke="#dc2626" stroke-width="3" marker-end="url(#arrowhead-red)"/>
    </g>
    
    <!-- Encoder-Decoder Loop -->
    <g id="loop" transform="translate(480, 60)">
      <!-- Loop container -->
      <rect x="0" y="0" width="520" height="240" rx="20" fill="white" stroke="#e2e8f0" stroke-width="2" stroke-dasharray="8,4" filter="url(#softShadow)"/>
      <text x="260" y="25" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="15" font-weight="600" fill="#64748b">Encoder-Decoder Loop</text>
      
      <!-- Decoder (bottom left) -->
      <g>
        <rect x="40" y="140" width="120" height="70" rx="12" fill="url(#purpleGradient)" filter="url(#softShadow)"/>
        <text x="100" y="170" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="17" font-weight="600" fill="white">Decoder</text>
        <text x="100" y="190" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="13" fill="#e9d5ff">D</text>
      </g>
      
      <!-- Encoder (top) -->
      <g>
        <rect x="260" y="50" width="120" height="70" rx="12" fill="url(#greenGradient)" filter="url(#softShadow)"/>
        <text x="320" y="80" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="17" font-weight="600" fill="white">Encoder</text>
        <text x="320" y="100" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="13" fill="#d1fae5">E</text>
      </g>
      
      <!-- Natural Language tokens (center) -->
      <g transform="translate(190, 140)">
        <text x="90" y="-8" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="12" font-weight="500" fill="#64748b">Natural Language Explanation</text>
        <g transform="translate(0, 5)">
          <!-- Left side: separate decoder and encoder prefixes -->
          <g>
            <!-- Decoder prefixes (purple, semi-transparent, full height) -->
            <rect x="0" y="0" width="20" height="36" rx="3" fill="#9333ea" fill-opacity="0.2" stroke="#9333ea" stroke-width="2" stroke-dasharray="3,2"/>
            <rect x="25" y="0" width="20" height="36" rx="3" fill="#9333ea" fill-opacity="0.2" stroke="#9333ea" stroke-width="2" stroke-dasharray="3,2"/>
            <rect x="50" y="0" width="20" height="36" rx="3" fill="#9333ea" fill-opacity="0.2" stroke="#9333ea" stroke-width="2" stroke-dasharray="3,2"/>
          </g>
          
          <!-- Natural language tokens -->
          <rect x="78" y="0" width="42" height="36" rx="8" fill="url(#orangeGradient)" filter="url(#tokenShadow)"/>
          <text x="99" y="24" text-anchor="middle" font-family="monospace" font-size="10" fill="white">tok₁</text>
          
          <rect x="128" y="0" width="42" height="36" rx="8" fill="url(#orangeGradient)" filter="url(#tokenShadow)"/>
          <text x="149" y="24" text-anchor="middle" font-family="monospace" font-size="10" fill="white">tok₂</text>
          
          <rect x="178" y="0" width="42" height="36" rx="8" fill="url(#orangeGradient)" filter="url(#tokenShadow)"/>
          <text x="199" y="24" text-anchor="middle" font-family="monospace" font-size="10" fill="white">tok₃</text>
          
          <rect x="228" y="0" width="42" height="36" rx="8" fill="url(#orangeGradient)" filter="url(#tokenShadow)"/>
          <text x="249" y="24" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="13" fill="white">...</text>
          
          <!-- Encoder prefixes (positioned with gap, bottom half only) -->
          <g transform="translate(278, 0)">
            <!-- Empty space above, encoder prefixes at bottom -->
            <rect x="0" y="18" width="20" height="18" rx="3" fill="#059669" fill-opacity="0.2" stroke="#059669" stroke-width="2" stroke-dasharray="3,2"/>
            <rect x="25" y="18" width="20" height="18" rx="3" fill="#059669" fill-opacity="0.2" stroke="#059669" stroke-width="2" stroke-dasharray="3,2"/>
            <rect x="50" y="18" width="20" height="18" rx="3" fill="#059669" fill-opacity="0.2" stroke="#059669" stroke-width="2" stroke-dasharray="3,2"/>
          </g>
          
          <!-- Right side: encoder postfixes (full height) -->
          <rect x="278" y="0" width="20" height="36" rx="3" fill="#059669" fill-opacity="0.2" stroke="#059669" stroke-width="2" stroke-dasharray="3,2"/>
          <rect x="303" y="0" width="20" height="36" rx="3" fill="#059669" fill-opacity="0.2" stroke="#059669" stroke-width="2" stroke-dasharray="3,2"/>
        </g>
        
        <!-- Small label for encoder path -->
        <text x="165" y="65" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#64748b" font-style="italic">To Encoder</text>
      </g>
      
      <!-- Flow arrows with linear layers (anti-clockwise) -->
      <!-- A to Decoder with linear layer -->
      <g>
        <path d="M -140 120 Q -50 140 40 175" stroke="#64748b" stroke-width="2.5" fill="none" marker-end="url(#arrowhead)"/>
        <!-- Linear layer on arrow -->
        <rect x="-70" y="142" width="30" height="6" rx="2" fill="#6366f1"/>
      </g>
      
      <!-- Decoder to NL tokens -->
      <path d="M 160 175 L 190 163" stroke="#64748b" stroke-width="2.5" marker-end="url(#arrowhead)"/>
      
      <!-- NL tokens upward to Encoder -->
      <path d="M 320 145 Q 320 95 320 120" stroke="#64748b" stroke-width="2.5" fill="none" marker-end="url(#arrowhead)"/>
      
      <!-- Encoder to A' with linear layer -->
      <g>
        <path d="M 380 85 Q 450 100 520 135" stroke="#64748b" stroke-width="2.5" fill="none" marker-end="url(#arrowhead)"/>
        <!-- Linear layer on arrow -->
        <rect x="435" y="96" width="30" height="6" rx="2" fill="#6366f1"/>
      </g>
    </g>
    
    <!-- Reconstructed A' (outside the loop) -->
    <g transform="translate(1080, 255)">
      <circle cx="0" cy="0" r="38" fill="url(#redGradient)" stroke="#dc2626" stroke-width="3" stroke-dasharray="6,3" filter="url(#glow)"/>
      <text x="0" y="7" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="22" font-weight="700" fill="white">A'</text>
      <text x="0" y="50" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="12" font-weight="500" fill="#64748b">Reconstructed</text>
    </g>
    
    <!-- Upward arrows to outputs -->
    <path d="M 340 142 Q 190 -50 190 -140" stroke="#3b82f6" stroke-width="3" stroke-dasharray="6,3" fill="none" marker-end="url(#arrowhead-blue)" opacity="0.5"/>
    
    <!-- A' loops back to forward pass from above -->
    <path d="M 1080 217 Q 1100 100 1000 -10 Q 900 -100 830 -140" stroke="#f97316" stroke-width="3" stroke-dasharray="6,3" fill="none" marker-end="url(#arrowhead-orange)" opacity="0.5"/>
  </g>
</svg> 